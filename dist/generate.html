<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brainiverse</title>
  
<link rel="stylesheet" href="./style.css">
<style>
    #app-card{  
    display: flex;
    flex-direction: column;
    overflow: visible;
    /* height: auto; */
    min-height: 100%;
    margin: 10px;
    width: 70%;
    font-size: 16px;
    /* background-color: var(--theme-bg-color); */
    /* border: 1px solid var(--theme-bg-color); */
    /* padding: 8px; */
    cursor: pointer;
    transition: 0.3s ease;
    }

    #app-card:hover{
    transform: scale(1.02);
    background-color: var(--theme-bg-color);
    }

    .bottom{
        width: 100%;
    /* border: 1px solid black; */
    overflow: hidden;
    }

    #but{
        /* margin-right: 0.2em; */
        display: flex;
        justify-content: center;
        width: 25%;
    float:left; /* add this */
    }
    .refresh{
        margin: 1.5em;
        border-color: var(--border-color);
        border-radius: 15px;
        padding: 5px;
        color: var(--theme-color);
        background-color: var(--content-bg);
        font-size:larger;
    }
    .refresh:hover{
    transform: scale(1.02);
    background-color: var(--theme-bg-color);
    }
    .output{
        overflow: hidden;
        background-color: var(--content-bg);
        padding: 10px;
        border-radius: 14px;
        /* font-family: var(--body-font); */
        font-size: 15px;
        font-weight: 500;
        /* margin: -10px -20px -10px 0px; */
        box-shadow: 0 0 0 2px rgba(21, 30, 62, 0.02);
    }

    @media screen and (max-width: 570px) {
  #but{
    width: 10%;
  }
  #app-card{
    display: inherit;
  }
  .left-side{
    display: contents;

  }
}

    #inputx, #inputy{
    width: 100%;
    min-height:20em;

    border: none;
    background-color: var(--theme-bg-color);
    border-radius: 14px;
    font-family: var(--body-font);
    font-size: 15px;
    font-weight: 500;
    /* margin: -10px -20px -10px 0px; */
    box-shadow: 0 0 0 2px rgba(21, 30, 62, 0.02);
    /* background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 56.966 56.966' fill='%23717790c7'%3e%3cpath d='M55.146 51.887L41.588 37.786A22.926 22.926 0 0046.984 23c0-12.682-10.318-23-23-23s-23 10.318-23 23 10.318 23 23 23c4.761 0 9.298-1.436 13.177-4.162l13.661 14.208c.571.593 1.339.92 2.162.92.779 0 1.518-.297 2.079-.837a3.004 3.004 0 00.083-4.242zM23.984 6c9.374 0 17 7.626 17 17s-7.626 17-17 17-17-7.626-17-17 7.626-17 17-17z'/%3e%3c/svg%3e"); */
    /* background-size: 14px; */
    background-repeat: no-repeat;
    /* background-position: 16px 48%; */
    color: var(--theme-color);
    }
</style>

</head>
<body>
<!-- partial:index.partial.html -->

<div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
     <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>
</div>


<div class="app">
    <div class="header">
     <div class="menu-circle"></div>
     <div class="header-profile">
        <p style="text-align:left; margin-right:6em; color: var(--content-title-color);"><b>Status</b> <span id="status">Loading...</span></p>
        <div class="notification">
         <span class="notification-number">3</span>
         <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell">
          <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0" />
         </svg>
        </div>
        <svg viewBox="0 0 512 512" fill="currentColor">
         <path d="M448.773 235.551A135.893 135.893 0 00451 211c0-74.443-60.557-135-135-135-47.52 0-91.567 25.313-115.766 65.537-32.666-10.59-66.182-6.049-93.794 12.979-27.612 19.013-44.092 49.116-45.425 82.031C24.716 253.788 0 290.497 0 331c0 7.031 1.703 13.887 3.006 20.537l.015.015C12.719 400.492 56.034 436 106 436h300c57.891 0 106-47.109 106-105 0-40.942-25.053-77.798-63.227-95.449z" />
        </svg>
        <img class="profile-img" src="https://images.unsplash.com/photo-1600353068440-6361ef3a86e8?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80" alt="">
       </div>
    </div>
    
    <div class="wrapper">

     <div class="main-container">

    <div class="main-header">

     
    </div>
    <div class="content-wrapper">
        <div class="main-header-link is-active">
            <section class="adobe-product">
                <form onsubmit="translateInput(event)" class="translation-form">
                    <div class="apps-card">

                        <div id="sidemen" class="left-side">
        <div class="pop-up__title" id="notescard" > Answer</div>                

                            <p style="display: none;">
                                <select id="inputLang" name="inputLang" class="input" onchange="onLangSelected(event)">
                                    <!-- <option value="Akkadian">Translate from Akkadian</option> -->
                                    <option value="English" selected>Translate from English</option>
                                    <!-- <option value="French">Translate from French</option>
                                    <option value="German">Translate from German</option>
                                    <option value="Romanian">Translate from Romanian</option> -->
                                    <!-- <option value="Sumerian">Translate from Sumerian</option> -->
                                </select>
                            </p>


                            <textarea id="inputy" name="input" class="input"
                                oninput="onInputChanged(event)">exist on a spectrum</textarea>

     
                            <p id="inputDebug" class="debug" style="display: none;"></p>
                        </div>
                        <div  id="app-card">
        <div class="pop-up__title" id="notescard" > Theory</div>                
                            
                            <textarea id="inputx" name="input" class="input">Neuroticism, one of the Big 5 personality traits, is typically defined as a tendency toward anxiety, depression, self-doubt, and other negative feelings. All personality traits, including neuroticism, exist on a spectrum—some people are just much more neurotic than others..</textarea>
                           
                        </div>
                        <div class="bottom">

                        <div id="but">
                        <button class="refresh" onclick="translateInput(event)">↺ Regenerate</button>
                        </div>

                        <div class="output" id="app-card">
                            <button class="flip-flop" onclick="flipFlop(event)" hidden>⇔</button>
                            <p style="display: none;">
                                <select id="outputLang" name="outputLang" class="output" onchange="onLangSelected(event)">
                                    <!-- <option value="Akkadian">Translate to Akkadian</option> -->
                                    <!-- <option value="English">Translate to English</option> -->
                                    <option value="French" selected>Translate to French</option>
                                    <option value="German">Translate to German</option>
                                    <option value="Romanian">Translate to Romanian</option>
                                    <!-- <option value="Sumerian">Translate to Sumerian</option> -->
                                </select>
                            </p>
                            <p id="output" class="textarea"></p>
                            <p id="outputDebug" class="debug" style="display: none;"></p>
                        </div>
                    </div>
                    </div>
                    <!-- <p style="text-align:center;">This translator uses the
                        <a id="modellink" href="https://huggingface.co/t5-base">t5-base</a>
                        neural network.</p> -->
                </form>
            </section>
            <!-- <section style="text-align: center;">
                <a href="/tests/test-tokenizers">Test Tokenizers</a></p>
            </section> -->
        </div>
        
    </div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
<script src="./tokenizers.js"></script>
<script src="./transformers.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<script  src="./script.js"></script>
<script type="text/javascript">

  const $status = document.getElementById("status");
  const $inputx = document.getElementById("inputx");
  const $inputy = document.getElementById("inputy");
  const $output = document.getElementById("output");
  const $inputDebug = document.getElementById("inputDebug");
  const $outputDebug = document.getElementById("outputDebug");
  const $inputLang = document.getElementById("inputLang");
  const $outputLang = document.getElementById("outputLang");
//   const $modellink = document.getElementById("modellink");

  const modelId = "t5_squad_v1";

  const generationOptions = {
      "maxLength": 256,
      "topK": 120,
      "top_p": 0.98,
      "num_return_sequences": 10
  };

  let tokenizer = null;
  let model = null;

  function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
  }

  function flipFlop(e) {
      e.preventDefault();
      const input = $input.value;
      $input.value = $output.innerText;
      $output.innerText = input;
      const inputLang = $inputLang.value;
      $inputLang.value = $outputLang.value;
      $outputLang.value = inputLang;
  }

  async function onInputChanged(e) {
      if (e) e.preventDefault();
      // Throttle calls to translateInput
      if (window.translateInputTimeout) {
          clearTimeout(window.translateInputTimeout);
      }
      window.translateInputTimeout = setTimeout(translateInput, 750);
  }

//   async function onLangSelected(e) {
//       if (e) e.preventDefault();
//       // Throttle calls to translateInput
//       if (window.translateInputTimeout) {
//           clearTimeout(window.translateInputTimeout);
//       }
//       window.translateInputTimeout = setTimeout(translateInput, 33);
//   }

  function getFullInput() {
      return `context: ${$inputx.value} answer: ${$inputy.value}`;
  }

  String.prototype.format = function () {
  var i = 0, args = arguments;
  return this.replace(/{}/g, function () {
      return typeof args[i] != 'undefined' ? args[i++] : '';
  });
  };



  async function translateInput(e) {
      if (e) e.preventDefault();
      if (tokenizer !== null && model !== null) {
          $status.innerText = "Analyzing and Generating...";
          await delay(33); // Give the UI a chance to update.
          // const x = getFullInput();
          // const y = getFullInput();
          const input =getFullInput();
          const inputTokenIds = tokenizer.encode(input);
          $inputDebug.innerText = inputTokenIds.join(" ");
          async function showOutput(outputTokenIds, forInputIds) {
              const newInputIds = tokenizer.encode(getFullInput());
              let inputSame = newInputIds.length === forInputIds.length;
              for (let i = 0; inputSame && i < newInputIds.length; i++) {
                  if (newInputIds[i] !== forInputIds[i]) {
                      inputSame = false;
                  }
              }
              if (inputSame) {
                  const str = tokenizer.decode(outputTokenIds, true).trim();
                  const output = str.substring(9);
                  $output.innerText = output;
                  $outputDebug.innerText = outputTokenIds.join(" ");
                  await delay(33); // Give the UI a chance to update.
              }
              return inputSame;
          }
          const finalOutputTokenIds = await model.generate(inputTokenIds, generationOptions, showOutput);
          console.log("output", finalOutputTokenIds);
          
          $status.innerText = "Ready";
      }
      else {
          $inputDebug.innerText = "Loading...";
          $outputDebug.innerText = "Loading...";
          $output.value = "";
      }
  }

  async function main() {
    //   $modellink.href = `https://huggingface.co/${modelId}`;
    //   $modellink.innerText = modelId;

      tokenizer = await AutoTokenizer.fromPretrained(modelId, "./models");
      console.log(tokenizer);
      model = await T5ForConditionalGeneration.fromPretrained(modelId, "/models", async function (progress) {
          const message = `Loading the neural network... ${Math.round(progress * 100)}%`;
          $status.innerText = message;
          $output.innerText = message;
          await delay(100); // Give the UI a chance to update.
      });
      console.log(model);
      $status.innerText = `Ready`;
      translateInput(null);
  }

  main();

</script>

</body>
</html>
